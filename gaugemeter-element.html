<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="./tweenlite-import.html">

<dom-module id="gaugemeter-element">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
  </template>
  <script>
    /**
     * `gaugemeter-element`
     * SVG Gauge meter component
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */

    const className = "GaugemeterElement";

    var _width = 0;
    var _centerX;
    var _centerY;
    
    var angleRange = 275;
    var minAngle = (360 - angleRange) / 2 + 90;

    var angle = minAngle;

    var radians = 0;
    var dotX = 0;
    var dotY = 0;

    var baseArc;
    var meterArc;
    var dot;

    var radiusDot = 0;

    class GaugemeterElement extends Polymer.Element {
      static get is() { return 'gaugemeter-element'; }
      static get properties() {
        return {
          radius: {
            type: Number,
            value: 120
          },
          baseArcStrokeWidth: {
            type: Number,
            value: 5
          },
          baseArcStrokeColor: {
            type: String,
            value: '#EEE'
          },
          meterArcStrokeWidth: {
            type: Number,
            value: 6
          },
          meterArcStrokeColor: {
            type: String,
            value: '#C00'
          },
          dotRadius: {
            type: Number,
            value: 10
          },
          dotColor: {
            type: String,
            value: '#C00'
          },
          meterValue: {
            type: Number,
            value: 0,
            reflectToAttribute: true
          }
        };
      };

      ready() {
        super.ready();
        angle = minAngle;
        angle %= 360;
        radians = (angle / 180) * Math.PI;

        this.render();
      };

      render() {
        console.log(className + ': render');
        //Caculate the full width of the component
        _width = (this.radius + this.baseArcStrokeWidth) * 2 + Math.max(0, this.dotRadius - this.baseArcStrokeWidth);
        _centerX = _width/2;
        _centerY = _width/2;

        radiusDot = this.radius - this.baseArcStrokeWidth;

        var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('version', '1.1');
        svg.setAttribute('width', _width);
        svg.setAttribute('height', _width);
        svg.setAttribute('viewBox', '0 0 ' + _width + ' ' + _width);
        svg.setAttribute('preserveAspectRatio', 'xMidYMid');

        var baseArcSVG = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        baseArcSVG.setAttribute("id", "base");
        baseArcSVG.setAttribute("fill", "none");
        baseArcSVG.setAttribute("stroke", this.baseArcStrokeColor);
        baseArcSVG.setAttribute("stroke-width", this.baseArcStrokeWidth);
        baseArcSVG.setAttribute("cx", _centerX);
        baseArcSVG.setAttribute("cy", _centerY);
        var r = this.radius - this.baseArcStrokeWidth;
        baseArcSVG.setAttribute("r", r);
        svg.appendChild(baseArcSVG);

        var meterArcSVG = document.createElementNS("http://www.w3.org/2000/svg", "path");
        meterArcSVG.setAttribute("id", "arc");
        meterArcSVG.setAttribute("fill", "none");
        //meterArcSVG.setAttribute("d", "M" + _width / 2 + ',' + _width / 2);
        meterArcSVG.setAttribute("stroke", this.meterArcStrokeColor);
        meterArcSVG.setAttribute("stroke-width", this.meterArcStrokeWidth);
        meterArcSVG.setAttribute('stroke-linecap', 'round');
        svg.appendChild(meterArcSVG);

        var dotSVG = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        dotSVG.setAttribute("id", "dot");
        dotSVG.setAttribute("fill", this.dotColor);
        dotSVG.setAttribute("cx", _centerX);
        dotSVG.setAttribute("cy", _centerY);
        dotSVG.setAttribute('r', this.dotRadius);
        svg.appendChild(dotSVG);

        //Polymer.dom(this.root).appendChild(svg);
        this.shadowRoot.appendChild(svg);

        dot = this.shadowRoot.querySelector('#dot');
        baseArc = this.shadowRoot.querySelector("#base");
        meterArc = this.shadowRoot.querySelector("#arc");

        var objAngle = { '_angle': angle };
        this._drawMeter(objAngle, true);

        //Add observer to the meter value property
        this._createPropertyObserver('meterValue', '_onMeterUpdate', true);
        //Set init meter value
        this._onMeterUpdate(this.meterValue, 0);
      };

      _onMeterUpdate(newValue, oldValue) {
        var destAngle = minAngle + newValue / 100 * angleRange;

        console.log(className + " : destAngle " + destAngle);
        var objAngle = { '_angle': angle };
        var tween = TweenLite.to(objAngle, 1, { _angle: destAngle, ease: Quad.easeOut, onUpdate: this._drawMeter, onUpdateParams: [objAngle], onUpdateScope: this });
      };

      _polarToCartesian(radius, angleInDegrees) {
        var angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;

        return {
          x: _centerX + (radius * Math.cos(angleInRadians)),
          y: _centerY + (radius * Math.sin(angleInRadians))
        };
      };

      _describeArc(radius, startAngle, endAngle) {
        var start = this._polarToCartesian(radius, endAngle);
        var end = this._polarToCartesian(radius, startAngle);

        var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

        var d = [
          "M", start.x, start.y,
          "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y
        ].join(" ");

        return d;
      };

      _drawMeter(newAngle, init) {
        //console.log("_drawMeter = "+ newAngle._angle);

        angle = newAngle._angle;
        radians = (angle / 180) * Math.PI;
        dotX = _centerX + Math.cos(radians) * radiusDot;
        dotY = _centerY + Math.sin(radians) * radiusDot;

        dot.setAttribute("cx", dotX);
        dot.setAttribute("cy", dotY);

        var d = this._describeArc(this.radius - this.baseArcStrokeWidth, minAngle + 90, angle + 90);
        meterArc.setAttribute("d", d);
      };

    };


    window.customElements.define(GaugemeterElement.is, GaugemeterElement);
  </script>
</dom-module>